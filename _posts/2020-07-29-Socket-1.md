---
layout: post
title: '制作一个基于.NET的WebApi服务映射工具(1) - Socket基础'
date: 2020-07-29
author: HANABI
color: rgb(59,46,42)
tags: Socket
---

> Socket编程是网络编程中的重中之重，.NET为我们提供了丰富，详细的类库为我们使用C#进行Socket编程提供帮助，这里作为学习，会尽可能使用相对基础的Socket类库，来完成整个程序的构建，首先我们来了解Socket，因为是直接学习Socket，对于更底层的协议不会推进得那么深入彻底，主要会介绍一些相对重要的概念

## 什么是TCP

面向**连接**的，**可靠**的传输协议

什么是连接：这里的连接不是指我们用网线进行的物理的连接，而是指一种逻辑上的连接，双方可以通过某种方式，访问到对方的资源，就称之为连接

在TCP中通过三次握手来完成连接，经过三次握手之后，双方会在内存开辟相应的**资源**(结构体，缓冲区等)，

为什么握手是三次，首先通信是双向的，客户端和服务端都有输入流，也有输出流

对于客户端来说，发一个数据去对面，对面也返回一个数据到我这里，证明客户端这边的通信是通的，对于服务端来说，收到对面的数据，证明输入是通的，此时回复一个包，对面收到之后再回复一个包，此时服务端才知道，自己的输出也是通的，这是一个**确认机制**，这确保了传输的可靠性

## 在Linux系统中用指令获取百度首页

`exec 5<> /dev/tcp/www.baidu.com/80`

创建一个socket通信，内核内部完成

`echo -e  "GET / HTTP/1.0\n" >&5`

用户空间的实现应用层协议

`cat <& 5`

## Socket是什么

### 概念浅析

Socket直译成“孔”或“插座”，作为进程之间的一种通信机制，通常也被称为“套接字”，是用于描述IP地址和端口号的通信链的句柄。

通俗的讲，人与人之间可以通过打电话来进行通信，程序与程序之间要进行通信，互相收发数据，就需要通过Socket来通信，所以不难理解为什么需要描述IP地址和端口号，把电话区号当作IP地址，后面的部分当作端口号，这样构成的一个完整的电话号码，才能和确切的某一个人进行通话，

在这个过程中，协议可以理解成打电话时双方沟通时用的语言，这篇里简单了解，TCP协议是面向连接的，是流式(STREAM)的，每次传输都需要建立三次握手，确保通信过程不会出现数据丢失

UDP协议是无连接的，是数据报式(DATAGRAM)的，不安全(丢失，顺序混乱，在接收端要分析重排及要求重发)，但效率高，在传输视频的时候通常使用UDP

### 一般应用模式

1.	服务端Socket开始监听端口，负责监听客户端连接信息
2.	客户端Socket连接服务端指定端口
3.	服务端监听到客户端连接，创建Connection Socket(负责和客户端通信的Socket)，开始进行通信

也就是说，在这个过程中，这里服务端有两个Socket，一个负责监听，一个负责通信，客户端从始至终只有一个Socket

> 这里通过打电话的例子，也有助于快速理解，通话双方都需要有电话(Socket)，通过电话号码(IP+端口号)呼叫对方，建立连接，开始通话

### 使用C#的Socket类进行Socket通信

这里直接上手写代码，之后会回来补上流程图和介绍等