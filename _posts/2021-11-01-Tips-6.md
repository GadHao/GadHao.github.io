---
layout: post
title: '自定义供日常使用的PowerShell脚本模块'
date: 2021-11-01
author: HANABI
tags: PowerShell
category: [经验技巧, 经验总结]
---

> 在使用Windows操作系统时，经常会以PowerShell作为Shell工具，本文描述如何封装自己经常使用的脚本供日常使用

## 编写脚本

在这里我们编写一个脚本，用来计算桌面上一个星期以上（大于或者等于8天）没有访问过的文件，因为是用于示例，这里使用相对容易理解的语法，并且添加了注释：

```powershell
function Get-OldFiles {
    # 获取桌面上所有的文件信息
    $all_files = Get-ChildItem $env:USERPROFILE\Desktop -Recurse -File

    # 循环文件信息，返回其文件名，路径，以及没有访问的天数
    foreach ($file in $all_files) {
        $not_access_day = ((Get-Date) - $file.LastAccessTime).Days
        if ($not_access_day -ge 8) {
            $value = [PSCustomObject] @{
                Name          = ""
                NotAccessDays = 0
                Path          = ""
            }
            $value.Name = $file.Name
            $value.Path = $file.FullName
            $value.NotAccessDays = $not_access_day
            Write-Output $value
        }
    }
}
```

可以看到，脚本里只有一个函数`Get-OldFiles`，这个函数可以用来查询出所有一个星期以上没有访问的文件信息，在保存这个文件之前，我们先要了解一些关于`PSModulePath`的内容，这些内容可以查看[about PSModulePath - PowerShell | Microsoft Docs](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_psmodulepath)

我们可以了解到，`PSModulePath`也就是PowerShell脚本模块的保存路径，PowerShell会在里面递归搜索`.psd1`和`.psm1`文件，并使其在当前PowerShell会话中可用，因此，我们现在要做的，就是把我们写好的脚本保存到`PSMoudulePath`，那么电脑上的`PsModulePath`指的是哪个文件夹呢，其实他不是一个文件夹，而是一些文件夹，`PowerShell`会在这些文件夹中寻找可以导入的模块。上面的链接中也有提及，这里进行简要说明（只对于没有自定义过`PSModulePath`，而使用默认路径的情况，关于如何自定义`PSModulePath`，也可以参考上面链接中的内容）：

对于Windows系统来说（提及的路径可以在PowerShell中输出出来，例如`Write-Output $PSHOME\Modules`）
- 用于Windows系统管理的模块放置在：`$PSHOME\Modules`

对于PowerShell 7.x版本：
- 用户自行安装（当前用户可用，安装时指定的`Scope`为`CurrentUser`）的模块放置在：`$HOME\Documents\PowerShell\Modules`
- 用户自行安装（所有用户可用，安装时指定的`Scope`为`AllUsers`）的模块放置在：`$env:ProgramFiles\PowerShell\Modules`

对于PowerShell 5.1版本（Win10自带PowerShell）:
- 用户自行安装（当前用户可用，安装时指定的`Scope`为`CurrentUser`）的模块放置在：`$HOME\Documents\WindowsPowerShell\Modules`
- 用户自行安装（所有用户可用，安装时指定的`Scope`为`AllUsers`）的模块放置在：`$env:ProgramFiles\WindowsPowerShell\Modules`

综上，现在我们想要新增的脚本模块对于这台电脑上的所有用户可用，我们选择将上面的脚本内容存储到`$env:ProgramFiles\WindowsPowerShell\Modules`文件夹

## 存储脚本

切换到上面说的文件夹：

```powershell
cd $env:ProgramFiles\PowerShell\Modules
```

在这里新建一个文件夹，值得说明的是，这个文件夹将会作为稍后的模块名称，我们这里编写的函数是和文件有关的，我们起名叫`FileTool`，于是接着上面的命令：

```powershell
mkdir FileTool; start FileTool
```

现在我们就创建并打开了我们的脚本模块文件夹，接着，我们将之前写好的脚本粘贴进任意的文本编辑器并保存到这个文件夹，文件后缀为`.psm1`即可，这里需要注意的是，一个模块里面至少要有一个文件和模块名称本身相同，关于这一点，可以查看[Installing a PowerShell Module - PowerShell | Microsoft Docs](https://docs.microsoft.com/en-us/powershell/scripting/developer/module/installing-a-powershell-module)页面的*Use the Correct Module Directory Name*部分，所以这里我们将其保存为`FileTool.psm1`

## 使用脚本

保存完成后，我们在PowerShell中使用`Get-Command -Module FileTool`命令，发现`FileTool`模块的命令列表被列出来了，由于我们这里只定义了一个，可以看到：

```plaintext
CommandType Name         Version Source
----------- ----         ------- ------
Function    Get-OldFiles 0.0     FileTool
```
输入`Get-OldFiles`命令，命令被正确执行，至此，自定义PowerShell脚本模块的过程完成

## 扩展内容

To be continued...

## 参考内容

[Script modules - PowerShell | Microsoft Docs](https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/10-script-modules)